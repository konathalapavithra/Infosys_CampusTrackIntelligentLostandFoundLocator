<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CampusTrack | Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; }
        .sidebar { background: #1e293b; color: white; min-height: 100vh; padding: 2rem; position: fixed; width: 250px; }
        .main-content { margin-left: 250px; padding: 3rem; }
        .table-card { background: white; border-radius: 16px; overflow: hidden; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .status-badge { padding: 5px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; }
        .bg-pending { background: #fef3c7; color: #92400e; }
        .bg-approved, .bg-available { background: #dcfce7; color: #166534; }
        .bg-rejected, .bg-returned { background: #fee2e2; color: #991b1b; }

        /* Sidebar Badge Styling */
        .count-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            background: #ef4444;
            color: white;
            border-radius: 10px;
            margin-left: 8px;
        }
        .nav-link:hover { color: #6366f1 !important; }
    </style>
</head>
<body>
<div class="sidebar">
    <h4 class="fw-bold mb-5">CampusTrack üõ°Ô∏è</h4>
    <nav class="nav flex-column">
        <a class="nav-link text-white fw-bold mb-3 d-flex align-items-center" href="#" onclick="showSection('claims')">
            <i class="bi bi-journal-text me-2"></i> Manage Claims
            <span id="pendingCountBadge" class="count-badge d-none">0</span>
        </a>
        <a class="nav-link text-white-50 mb-3" href="#" onclick="showSection('items')">
            <i class="bi bi-box-seam me-2"></i> Manage Inventory
        </a>

        <a class="nav-link text-white-50 mb-3" href="#" onclick="goToAnalytics()">
            <i class="bi bi-bar-chart-fill me-2"></i> Analytics
        </a>

        <hr>
        <a class="nav-link text-danger fw-bold" href="login.html">
            <i class="bi bi-box-arrow-right me-2"></i> Logout
        </a>
    </nav>
</div>

<div class="main-content">
    <div id="claimsSection">
        <h2 class="fw-bold mb-4">Pending Claims</h2>
        <div class="table-card">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                <tr>
                    <th class="ps-4">Item ID</th>
                    <th>Claimer Email</th>
                    <th>Proof</th>
                    <th>Status</th>
                    <th class="text-end pe-4">Actions</th>
                </tr>
                </thead>
                <tbody id="claimsTable"></tbody>
            </table>
        </div>
    </div>

    <div id="itemsSection" class="d-none mt-5">
        <h2 class="fw-bold mb-4">Inventory Management</h2>
        <div class="table-card">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                <tr>
                    <th class="ps-4">Title</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th class="text-end pe-4">Actions</th>
                </tr>
                </thead>
                <tbody id="itemsTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function showSection(section) {
        document.getElementById('claimsSection').classList.toggle('d-none', section !== 'claims');
        document.getElementById('itemsSection').classList.toggle('d-none', section !== 'items');
        if(section === 'items') fetchItems();
    }

    function goToAnalytics() {
        window.location.href = "admin1.html";
    }

    // --- CLAIM FUNCTIONS ---
    async function fetchClaims() {
        try {
            const response = await fetch('/api/claims');
            const claims = await response.json();

            // Update Sidebar Badge
            updateBadge(claims);

            const table = document.getElementById('claimsTable');
            table.innerHTML = claims.map(claim => `
                <tr>
                    <td class="ps-4 fw-bold">#${claim.itemId}</td>
                    <td>${claim.claimerEmail}</td>
                    <td class="text-muted small">${claim.proofOfOwnership}</td>
                    <td><span class="status-badge bg-${claim.status.toLowerCase()}">${claim.status}</span></td>
                    <td class="text-end pe-4">
                        <button onclick="updateClaimStatus(${claim.id}, 'APPROVED')" class="btn btn-sm btn-success rounded-pill px-3 me-2">Approve</button>
                        <button onclick="updateClaimStatus(${claim.id}, 'REJECTED')" class="btn btn-sm btn-outline-danger rounded-pill px-3">Reject</button>
                    </td>
                </tr>`).join('');
        } catch (error) { console.error("Error loading claims:", error); }
    }

    // Updates the red badge in the sidebar
    function updateBadge(claims) {
        const pendingCount = claims.filter(c => c.status === 'PENDING').length;
        const badge = document.getElementById('pendingCountBadge');
        if (pendingCount > 0) {
            badge.innerText = pendingCount;
            badge.classList.remove('d-none');
        } else {
            badge.classList.add('d-none');
        }
    }

    async function updateClaimStatus(id, newStatus) {
        try {
            const response = await fetch(`/api/claims/${id}/status?status=${newStatus}`, { method: 'PUT' });
            if (response.ok) { fetchClaims(); }
        } catch (error) { alert("Update failed"); }
    }

    // --- ITEM FUNCTIONS ---
    async function fetchItems() {
        try {
            const response = await fetch('/api/items');
            const items = await response.json();
            const table = document.getElementById('itemsTable');
            table.innerHTML = items.map(item => `
                <tr>
                    <td class="ps-4 fw-bold">${item.title}</td>
                    <td>${item.category}</td>
                    <td><span class="status-badge bg-${item.status.toLowerCase()}">${item.status}</span></td>
                    <td class="text-end pe-4">
                        <button onclick="markReturned(${item.id})" class="btn btn-sm btn-outline-success me-2" ${item.status === 'RETURNED' ? 'disabled' : ''}>
                            <i class="bi bi-check-circle"></i> Returned
                        </button>
                        <button onclick="deleteItem(${item.id})" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>`).join('');
        } catch (error) { console.error("Error loading items:", error); }
    }

    async function markReturned(id) {
        if (confirm("Mark this item as successfully returned?")) {
            const response = await fetch(`/api/items/${id}/returned`, { method: 'PUT' });
            if (response.ok) fetchItems();
        }
    }

    async function deleteItem(id) {
        if (confirm("Permanently delete this item?")) {
            const response = await fetch(`/api/items/${id}`, { method: 'DELETE' });
            if (response.ok) fetchItems();
        }
    }

    fetchClaims();
</script>
</body>
</html>